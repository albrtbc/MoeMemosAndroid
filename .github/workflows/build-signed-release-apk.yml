name: Build Release APK

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-*"
      - "[0-9]+.[0-9]+.[0-9]+"
      - "[0-9]+.[0-9]+.[0-9]+-*"
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-release-apk:
    runs-on: ubuntu-latest

    env:
      RELEASE_TAG: ${{ inputs.tag_name || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Determine build type
        id: build-type
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [[ -n "$ANDROID_KEYSTORE_BASE64" ]]; then
            echo "signed=true" >> "$GITHUB_OUTPUT"
            echo "Building signed release APK"
          else
            echo "signed=false" >> "$GITHUB_OUTPUT"
            echo "No signing secrets found, building debug APK"
          fi

      - name: Prepare release keystore
        if: steps.build-type.outputs.signed == 'true'
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > "${RUNNER_TEMP}/release.keystore"

      - name: Build signed release APK
        if: steps.build-type.outputs.signed == 'true'
        env:
          ANDROID_SIGNING_STORE_FILE: ${{ runner.temp }}/release.keystore
          ANDROID_SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}
          ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          ANDROID_SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
        run: ./gradlew :app:assembleRelease

      - name: Build debug APK
        if: steps.build-type.outputs.signed == 'false'
        run: ./gradlew :app:assembleDebug

      - name: Rename APK with tag
        run: |
          if [[ "${{ steps.build-type.outputs.signed }}" == "true" ]]; then
            APK_PATH="app/build/outputs/apk/release/app-release.apk"
          else
            APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          fi
          if [[ ! -f "$APK_PATH" ]]; then
            echo "APK not found at $APK_PATH"
            exit 1
          fi
          cp "$APK_PATH" "moememos-${RELEASE_TAG}.apk"

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: moememos-${{ env.RELEASE_TAG }}
          path: moememos-${{ env.RELEASE_TAG }}.apk

      - name: Upload APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: moememos-${{ env.RELEASE_TAG }}.apk
          generate_release_notes: true
          tag_name: ${{ env.RELEASE_TAG }}
          prerelease: ${{ contains(env.RELEASE_TAG, '-') }}
